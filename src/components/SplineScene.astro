---
/**
 * Spline Scene Component
 * PERFORMANCE OPTIMIZED: Lazy loads after page is interactive
 * Only loads when user has scrolled or after 3 seconds idle
 */
---

<canvas id="spline-canvas" class="spline-canvas"></canvas>

<script is:inline>
  // Lazy load Spline to prevent blocking main thread (6+ seconds!)
  (function() {
    const SCENE_URL = 'https://prod.spline.design/H0BsfAOW2BCmCUyJ/scene.splinecode';
    const canvas = document.getElementById('spline-canvas');
    if (!canvas) return;

    let splineLoaded = false;

    async function loadSpline() {
      if (splineLoaded) return;
      splineLoaded = true;

      try {
        // Dynamically import the heavy Spline runtime
        const { Application } = await import('https://unpkg.com/@splinetool/runtime@1.9.28/build/runtime.js');

        const app = new Application(canvas);
        await app.load(SCENE_URL);

        // Mark as loaded
        const container = document.querySelector('.spline-container');
        if (container) {
          container.classList.add('loaded');
        }
      } catch (error) {
        // Silent fail - 3D is non-critical
      }
    }

    // Strategy: Load after page is interactive OR user scrolls
    // This prevents blocking LCP and main thread work

    // Option 1: Load after 3 seconds (page should be interactive by then)
    const idleTimeout = setTimeout(loadSpline, 3000);

    // Option 2: Load immediately if user scrolls (shows engagement)
    const scrollHandler = () => {
      clearTimeout(idleTimeout);
      window.removeEventListener('scroll', scrollHandler);
      // Use requestIdleCallback if available for smoother loading
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadSpline);
      } else {
        setTimeout(loadSpline, 100);
      }
    };
    window.addEventListener('scroll', scrollHandler, { once: true, passive: true });

    // Option 3: Load when browser is idle (best for performance)
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        clearTimeout(idleTimeout);
        window.removeEventListener('scroll', scrollHandler);
        loadSpline();
      }, { timeout: 5000 });
    }
  })();
</script>

<style>
  .spline-canvas {
    width: 100%;
    height: 100%;
    display: block;
    /* Hardware acceleration for better performance */
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
  }
</style>
